# sel4调研报告

seL4是世界上**最小的内核之中的一个**，可是seL4的性能能够与当今性能最好的微内核相比。
 作为微内核，seL4为应用程序提供少量的服务。如创建和管理虚拟内存地址空间的抽象，线程和进程间通信IPC。这么少的服务靠**8700**行C代码搞定。seL4是高性能的L4微内核家族的新产物，它具有操作系统所必需的服务。如线程，IPC，虚拟内存，中断等。

seL4 是第一个（也是唯一一个）具有合理和完整及时性分析的保护模式操作系统内核。除此之外，这意味着它在中断延迟（以及任何其他内核操作的延迟）方面具有可证明的上限。因此，它是唯一具有内存保护功能的内核，可以为您提供硬实时保证。

sel4的问题：separation-kernel 配置的 seL4 保证数据保密性 (confidentiality)，也就是**没有授权就不能读取数据**。 但这个证明没有考虑时间，还不能杜绝 timing channel 。 seL4 目前用的信息流记号局限很大，只适用于很窄的现实场景， 还需要寻找一个更实用的 confidentiality notion。

## 概述

seL4是一个高安全性、高性能的操作系统微内核，是L4系列微内核中的一个，由Trustworthy Systems Group于2009年发布，支持主流的ARM、x86和RISC-V架构，现已开源并成立基金会。

seL4的突出特点在于其经过形式化验证的安全性，以及保障安全性的同时所具有的高性能，在对于安全性要求较高的军事、商业、政治领域有着众多应用场景。

## 特性

### 最小化原则

seL4作为一个微内核，为所有系统服务和用户程序提供资源的访问控制、为各个系统组件提供通信，是操作系统的核心部分，具有优先权限。seL4坚持了微内核的“最小化原则”，将大量的硬件驱动和系统服务裁减掉，甚至将内核内存分配和时间片分配丢到用户空间中，以实现微内核的最小化。由此带来的好处是拥有许多的应用场景，为场景中的多种操作系统提供可靠的基础支持。

### 安全性

L4系列微内核已经是全球最先进、最安全的操作系统内核，而seL4又在其中出类拔萃。seL4是世界上第一个且是迄今为止唯一一个经过安全性形式验证的操作系统。seL4的安全性表现为在它为系统中运行的应用程序之间的隔离提供了最高的保证 ，这意味着可以遏制系统某一部分的妥协，并防止损害该系统其他可能更关键的部分。

### 性能

正如seL4官网标题下的第一条标语：“Security is no excuse for bad performance（安全性不是降低性能的借口）”，seL4在保障了首屈一指的安全性的同时也兼顾了其性能。seL4的性能较此前的系统内核不仅没有降低，反而得到了增强。一个显著的指标就是其IPC时间较之其他的OS内核减少了至少一半。

## 内核基本服务清单

1.线程抽象：支持运行软件的CPU执行；

2.分配地址空间：为应用程序提供虚拟的内存空间，使应用程序只能访问该空间中的内存而不会破坏系统空间；

3.管理进程间通信：允许进程间通过端点进行数据传输，协调各个进程的资源占用和释放；

4.通知：提供类似于二进制信号量的非阻塞信号机制，让进程的数据访问更加高效；

5.设备原语：将设备驱动程序作为非特权应用程序实现，内核通过IPC消息导出硬件设备中断；

6.分配功能空间：分配存储内核服务的内存空间并设置特权权限。

## 访问控制

seL4微内核提供了一个基于功能的访问控制模型。访问控制管理所有内核服务，为了执行操作，应用程序必须调用其拥有的对请求的服务具有足够访问权限的功能。

访问控制将操作系统配置为相互隔离的软件组件，通过有选择地授予特定的通信能力，在组件之间启用授权的、受控的通信，使得软件组件具有高度保证的隔离，因为只有那些由能力占有明确授权的操作才被允许。

## 系统调用

seL4内核提供了一个用于在线程之间传递消息的服务，该机制还用于与内核提供的服务进行通信。该通信服务传递的消息具有标准的格式，每个消息包含一些数据字和一些可能的功能。

线程通过调用其功能空间中的功能来发送消息，当以这种方式调用一个端点功能时，消息将通过内核传输到另一个线程。当调用内核对象的功能时，消息将被解释为以特定于内核对象类型的方式进行的方法调用。

逻辑上，内核提供三个系统调用：发送、接收和输出。除此之外，还有一些基本的Send和Receive调用的组合和变体，如Call操作，由来自同一个对象的一个Send和一个Receive组成。除了端点和通知之外，内核对象上的方法都映射到发送或调用，具体映射到哪种方法取决于方法是否返回结果。

## 内核对象

seL4微内核中实现了一些对象类型，这些类型的实例（也称为“对象”）可以由应用程序调用，而这些对象的接口也构成了内核本身的接口。内核服务的创建和使用是通过创建、操作和组合这些对象来实现的。具体的对象类型如下：

1.**CNodes**:存储功能，允许线程调用特定对象上的方法，每个结点都有固定数量的插槽，数量通常为2^n个。插槽数量取决于结点的创建时间，插槽可以是空的也可以包含功能;

2.**TCB**（线程控制块）:表示seL4中的一个运行线程，线程是调度、阻塞、非阻塞等的执行单元，具体执行的内容取决于应用程序与其他线程的交互;

3.**Endpoints**（端点）：负责进程之间的消息传输。通过端点进行的IPC是同步的，试图在端电上发送或接收消息的线程会阻塞，直到消息可以传递为止，这意味着只有当发送者和接收者在端点汇合时，消息传递才会发生，内核可以通过一个拷贝传递消息。端点的功能可以被限制为只发送或只接收。端点功能可以拥有授予权，这允许将功能作为消息的一部分发送;

4.**通知对象**：提供一个简单的信号机制。一个通知是1Byte大小的标志数组，每个标志的行为都像一个二进制信号量。在单个操作中向标志的子集发出信号，轮询检查所有标志，并保持阻塞直到某一标志作为标志被发出。通知功能可以是仅限信号的或仅限等待的;

5.**虚拟地址空间对象**：用于为一个或多个线程构造虚拟地址空间，这些对象很大程度上直接对应于硬件对象，因此依赖于体系结构。内核还包括用于跟踪地址空间状态的ASID池和ASID控制对象;

6.**中断对象**：中断对象给应用程序接收和确认来自硬件设备的中断的能力。最初，IRQControl有一个功能，它允许创建IRQHandler功能。IRQHandler功能允许管理与特定设备相关联的特定中断源。它被委托给一个设备驱动程序来访问中断源。IRQHandler对象允许线程等待并确认单个中断;

7.**非类型化内存**：无类型内存是sel4内核中内存分配的基础。非类型化内存功能只有一个方法：创建新的内核对象。如果方法成功，调用线程将获得对新创建对象的功能的访问权。此外，非类型化内存对象可以划分为一组较小的非类型化内存对象，允许委托部分(或全部)系统内存。

## 内核内存分配

seL4微内核不为内核对象动态分配内存，必须通过非类型化内存能力，从应用程序控制的内存区域显式创建对象。应用程序必须有明确的内存权限（通过非类型化内存能力）才能创建新对象，并且所有对象一旦创建就会消耗固定数量的内存。这些机制可用于精确控制应用程序可用的物理内存的具体数量，包括能够强制隔离应用程序或设备之间的物理内存访问。

除了由硬件规定的资源之外，内核中没有对任何资源的限制，因此可以避免许多由于资源耗尽而导致的拒绝服务。

在引导时，seL4预先分配内核本身所需的内存，包括代码、数据和堆栈部分。然后创建一个具有适当的地址和功能空间的初始用户线程。然后，内核将所有剩余内存以非类型化内存的功能形式交给初始线程，并将引导初始线程所需的一些额外的内核对象功能交给初始线程。然后可以使用seL4 Untyped Retype()方法将这些非类型化内存区域分割为更小的区域或其他内核对象，创建的对象被称为原始无类型内存对象的子对象。

使用seL4 Untyped Retype()创建对象的用户级应用程序，将接收对结果对象的全部权限。然后，它可以将其对该对象拥有的全部或部分权限委托给一个或多个客户端。

非类型化内存对象表示两种不同类型的内存：通用内存或设备内存。 通用内存可以非类型化为任何其他对象类型，并接受内核提供的非类型化内存上的任何操作。设备内存覆盖由硬件平台决定的为设备预留的内存区域，这些对象的使用受到内核以下方式的限制:

1. 设备非类型化对象只能重新键入到帧或其他非类型化对象中；例如，开发人员不能从设备内存创建端点；
2. 从设备中重新类型化的帧对象不能设置为线程IPC缓冲区，或用于创建ASID池；

子无类型对象的类型属性继承自父亲的无类型对象，也就是说，未类型化设备的任何子设备也将是一个未类型化设备。开发人员不能更改无类型的类型属性。

## 总结

seL4操作系统微内核在达到了极高的安全标准的同时兼顾了良好的性能，其微内核式的设计也为其向各个平台移植打下了坚实的基础。seL4的开源有利于本项目进行深入研究、探讨、参考和借鉴。目前暂定的seL4借鉴内容有：微内核结构、安全性实现、访问控制与进程隔离；要进行修改的内容有：进程间mmap通信、在浏览器环境下运行、rust语言编写。

## 参考文献

1.seL4官网——[Home | seL4](https://sel4.systems/)

2.sel4 手册总结之介绍与内核服务和对象——[(4条消息) sel4 手册总结之介绍与内核服务和对象_LinHan_Li的博客-CSDN博客](https://blog.csdn.net/weixin_38849460/article/details/112788571)